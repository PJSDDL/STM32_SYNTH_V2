#include "MIDI.H"

//每三个数代表一个事件，三个数的含义依次是音调、时间、力度
const u32 MIDI_1[216] = {
76,1,100,0,199,64,69,201,100,0,399,64,72,401,100,0,599,64,76,601,100,0,799,64,77,
801,100,0,999,64,76,1001,100,0,1199,64,74,1201,100,0,1399,64,72,1401,100,0,1599,64,71,1601,
100,0,1799,64,77,1801,100,0,1999,64,76,2001,100,0,2099,64,74,2101,100,0,2199,64,72,2201,100,
0,2299,64,71,2301,100,0,2399,64,72,2401,100,0,2599,64,74,2601,100,0,2799,64,76,2801,100,0,
2999,64,76,3200,100,0,3399,64,69,3401,100,0,3599,64,72,3601,100,0,3799,64,76,3801,100,0,3999,
64,77,4001,100,0,4199,64,76,4201,100,0,4399,64,74,4401,100,0,4599,64,72,4601,100,0,4799,64,
68,4801,100,0,5099,64,69,5101,100,0,5399,64,71,5401,100,0,5599,64,69,5601,100,0,5699,64,71,
5701,100,0,5799,64,72,5801,100,0,5899,64,74,5901,100,0,5999,64,76,6001,100,0,6099,64,74,6101,
100,0,6199,64,71,6201,100,0,6299,64,69,6301,100,0,6399,64,
};

const u32 MIDI_2[24] = {
57,1,100,0,799,64,59,1600,100,0,2399,64,60,3200,100,0,3999,64,62,4800,100,0,5599,64,
};

const u32 MIDI_3[30] = {
60,1,100,0,799,64,64,1600,100,0,2399,64,64,3200,100,0,3999,64,65,4800,100,0,5599,64,64,
5601,100,0,6399,64,
};

const u32 MIDI_4[378] = {
57,1,100,0,99,64,60,101,100,0,199,64,64,201,100,0,299,64,69,301,100,0,399,64,64,
401,100,0,499,64,60,501,100,0,599,64,57,601,100,0,699,64,60,701,100,0,799,64,64,801,
100,0,899,64,69,901,100,0,999,64,64,1001,100,0,1099,64,60,1101,100,0,1199,64,57,1201,100,
0,1299,64,60,1301,100,0,1399,64,64,1401,100,0,1499,64,69,1501,100,0,1599,64,64,1601,100,0,
1699,64,59,1701,100,0,1799,64,56,1801,100,0,1899,64,62,1901,100,0,1999,64,64,2001,100,0,2099,
64,67,2101,100,0,2199,64,64,2201,100,0,2299,64,62,2301,100,0,2399,64,56,2401,100,0,2499,64,
62,2501,100,0,2599,64,64,2601,100,0,2699,64,67,2701,100,0,2799,64,64,2801,100,0,2899,64,62,
3000,100,0,3099,64,56,3101,100,0,3199,64,60,3201,100,0,3299,64,64,3301,100,0,3399,64,60,3401,
100,0,3499,64,55,3501,100,0,3599,64,60,3601,100,0,3699,64,64,3701,100,0,3799,64,60,3801,100,
0,3899,64,55,3901,100,0,3999,64,60,4001,100,0,4099,64,64,4101,100,0,4199,64,60,4201,100,0,
4299,64,55,4301,100,0,4399,64,60,4401,100,0,4499,64,64,4501,100,0,4599,64,60,4601,100,0,4699,
64,55,4701,100,0,4799,64,56,4801,100,0,4899,64,62,4901,100,0,4999,64,64,5001,100,0,5099,64,
62,5101,100,0,5199,64,56,5201,100,0,5299,64,62,5301,100,0,5399,64,64,5401,100,0,5499,64,62,
5501,100,0,5599,64,57,5601,100,0,5699,64,60,5701,100,0,5799,64,64,5801,100,0,5899,64,60,5901,
100,0,5999,64,57,6001,100,0,6099,64,60,6101,100,0,6199,64,64,6201,100,0,6299,64,60,6301,100,
0,6399,64,
};

const u32 MIDI_5[378] = {
57,1,100,0,99,64,60,101,100,0,199,64,64,201,100,0,299,64,69,301,100,0,399,64,64,
401,100,0,499,64,60,501,100,0,599,64,57,601,100,0,699,64,60,701,100,0,799,64,64,801,
100,0,899,64,69,901,100,0,999,64,64,1001,100,0,1099,64,60,1101,100,0,1199,64,57,1201,100,
0,1299,64,60,1301,100,0,1399,64,64,1401,100,0,1499,64,69,1501,100,0,1599,64,64,1601,100,0,
1699,64,59,1701,100,0,1799,64,56,1801,100,0,1899,64,62,1901,100,0,1999,64,64,2001,100,0,2099,
64,67,2101,100,0,2199,64,64,2201,100,0,2299,64,62,2301,100,0,2399,64,56,2401,100,0,2499,64,
62,2501,100,0,2599,64,64,2601,100,0,2699,64,67,2701,100,0,2799,64,64,2801,100,0,2899,64,62,
3000,100,0,3099,64,56,3101,100,0,3199,64,60,3201,100,0,3299,64,64,3301,100,0,3399,64,60,3401,
100,0,3499,64,55,3501,100,0,3599,64,60,3601,100,0,3699,64,64,3701,100,0,3799,64,60,3801,100,
0,3899,64,55,3901,100,0,3999,64,60,4001,100,0,4099,64,64,4101,100,0,4199,64,60,4201,100,0,
4299,64,55,4301,100,0,4399,64,60,4401,100,0,4499,64,64,4501,100,0,4599,64,60,4601,100,0,4699,
64,55,4701,100,0,4799,64,56,4801,100,0,4899,64,62,4901,100,0,4999,64,64,5001,100,0,5099,64,
62,5101,100,0,5199,64,56,5201,100,0,5299,64,62,5301,100,0,5399,64,64,5401,100,0,5499,64,62,
5501,100,0,5599,64,57,5601,100,0,5699,64,60,5701,100,0,5799,64,64,5801,100,0,5899,64,60,5901,
100,0,5999,64,57,6001,100,0,6099,64,60,6101,100,0,6199,64,64,6201,100,0,6299,64,60,6301,100,
0,6399,64,
};

const u32 MIDI_6[48] = {
48,1,100,0,399,64,48,800,100,0,1199,64,48,1600,100,0,1999,64,48,2400,100,0,2799,64,48,
3200,100,0,3599,64,48,4000,100,0,4399,64,48,4800,100,0,5199,64,48,5600,100,0,5999,64,
};

const u32 MIDI_7[12] = {
52,1,100,0,399,64,52,3200,100,0,3599,64,
};

//C2到C7
unsigned int Note_Freq[72] = {
    65, 69, 73, 78, 82, 87, 92, 98, 104, 110, 117, 123,
    130, 139, 147, 156, 165, 175, 185, 196, 208, 220, 233, 246,
    262, 277, 294, 311, 330, 349, 370, 392, 415, 440, 466, 493,
    523, 554, 587, 622, 659, 698, 740, 784, 831, 880, 932, 988,
    1046, 1109, 1175, 1245, 1319, 1396, 1480, 1568, 1661, 1760, 1865, 1976,
    2092, 2218, 2350, 2490, 2638, 2792, 2960, 3136, 3322, 3520, 3730, 3952,
};

void MIDI_Control(struct MIDI_CTRL *ctrl, const u32 MIDI_list[], u8 *trig)
{
    if (ctrl->clk_div <= 18)
    {
        ctrl->clk_div ++;
    }
    else
    {
        ctrl->clk_div = 0;
        ctrl->mid_cnt ++;
    }

    //判断是否需要读取下一个音符
    if (MIDI_list[ctrl->mid_index + 1] == ctrl->mid_cnt)
    {
        //音调为0关闭音符
        if (MIDI_list[ctrl->mid_index + 0] == 0)
        {
            *trig = 0;
            ctrl->mid_freq = 0;
        }
        else
        {
            *trig = 1;
            u8 note_num = MIDI_list[ctrl->mid_index + 0];
            //ctrl->mid_note = Note_Freq[note_num-48];
            ctrl->mid_freq = Note_Freq[note_num + ctrl->note_shift - 48];
        }

        ctrl->mid_vec = MIDI_list[ctrl->mid_index + 2];

        ctrl->mid_index += 3;
    }
}

void MIDI_CTRL_INIT(struct MIDI_CTRL ctrl[], u32 len)
{
    for (u8 index = 0; index < len; index++)
    {
        ctrl[index].clk_div = 0;
        ctrl[index].mid_cnt = (u32)-1;
        ctrl[index].mid_index = 0;
		ctrl[index].note_shift = 0;
    }
}
